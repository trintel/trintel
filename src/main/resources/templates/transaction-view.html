<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:include="layout :: page">

<head>
	<th:block th:fragment="title"><title>Trintel</title></th:block>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>

<body>
	<th:block th:fragment="content">
		<h1 th:text="#{transactionProgress}"></h1>
		<h3 class="mb-3" th:text="|${actions[0].transaction.buyer.name} #{buying} ${actions[0].transaction.product} #{from} ${actions[0].transaction.seller.name}|"></h3>
		<!-- Accordion for every action in chosen transaction to visualize transaction progress -->
		<div th:unless="${actions.isEmpty()}">
			<div class="accordion" id="accordionPanelsStayOpenExample">
				<div th:each="action: ${actions}">
					<div class="accordion-item mb-3">
						<!-- Accordion header/button -->
						<h4 class="accordion-header" th:id="'panelsStayOpen-headingOne'+${action.id}">
							<button class="accordion-button" th:classappend="${{action.id == actions[#lists.size(actions)-1].id} ? '':'collapsed'}" th:aria-labelledby="'panelsStayOpen-headingOne'+${action.id}" type="button" data-bs-toggle="collapse" th:data-bs-target="'#panelsStayOpen-collapseOne'+${action.id}" aria-expanded="true" th:aria-controls="'panelsStayOpen-collapseOne'+${action.id}">
								<div th:switch="${action.actiontype.name}">
									<h4 th:case="Request"><div class="badge bg-danger me-3" th:text="#{requestTLV}"></div></h4>
									<h4 th:case="Offer"><div class="badge bg-warning me-3" th:text="#{offerTLV}"></div></h4>
									<h4 th:case="Accept"><div class="badge bg-success me-3" th:text="#{acceptTV}"></div></h4>
									<h4 th:case="Abort"><div class="badge bg-light text-dark me-3" th:text="#{abortTV}"></div></h4>
									<h4 th:case="Delivery"><div class="badge bg-primary me-3" th:text="#{deliveryTLV}"></div></h4>
									<h4 th:case="Invoicing"><div class="badge bg-dark me-3" th:text="#{invoicingTLV}"></div></h4>
									<h4 th:case="Paid"><div class="badge bg-primary me-3" th:text="#{paidTV}"></div></h4>
									<h4 th:case="*"><div class="badge bg-secondary me-3" th:text="${action.actiontype.name}"></div></h4>
								</div>
								<div>
									<div class="text-muted" style="font-size: 15px" th:text="#{initiatingCompany}"></div>
									<div class="text-black"><h5 class="text-break" th:text="${action.initiator.company.name}"></h5></div>
								</div>
						</h4>
						<!-- Accordion body -->
						<div th:id="'panelsStayOpen-collapseOne'+${action.id}" class="accordion-collapse collapse" th:classappend="${{action.id == actions[#lists.size(actions)-1].id} ? 'show':''}" th:aria-labelledby="'panelsStayOpen-headingOne'+${action.id}">
							<div class="accordion-body d-flex">
								<div class="me-5" sec:authorize="hasRole('ADMIN')">
									<span class="text-muted" style="font-size: 15px" th:text="#{initiatingStudent}"></span>
									<span class="text-black"><h5 th:text="${action.initiator.forename} + ' ' + ${action.initiator.surname}"></h5></span>
								</div>
								<div class="me-5">
									<span class="text-muted" style="font-size: 15px" th:text="#{date}"></span>
									<span class="text-black"><h5 th:text="${action.date}"></h5></span>
								</div>
								<div>
									<span class="text-muted" style="font-size: 15px" th:text="#{time}"></span>
									<span class="text-black"><h5 th:text="${action.time}"></h5></span>
								</div>
							</div>
							<div class="accordion-body d-flex">
								<div class="me-5">
									<span class="text-muted" style="font-size: 15px" th:text="#{amount}"></span>
									<span class="text-black"><h5 th:text="${action.transaction.amount}"></h5></span>
								</div>
								<div th:unless="${action.actiontype.name} == 'Request'" class="me-5">
									<div class="text-muted" style="font-size: 15px" th:text="#{pricePerPiece}"></div>
									<div class="text-black"><h5 th:text="${action.transaction.pricePerPiece}"></h5></div>
								</div>
								<div>
									<span class="text-muted" style="font-size: 15px" th:text="#{message}"></span>
									<span class="text-black"><h5 th:text="${action.message}" class="text-break"></h5></span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Buttons to react to last action for student -->
			<div sec:authorize="hasRole('STUDENT')">
				<div class="d-flex justify-content-center">
					<div th:each="actiontype: ${actiontypes}">
						<div th:switch="${actiontype.name}">
							<!-- "Offer" button -->
							<a th:case="Offer" class="btn btn-primary btn-lg me-3" th:text="#{offerNA}" th:href="@{'/transaction/' + ${transactionID} + '/addOffer'}"></a>
							<!-- Modal for "Accept" button -->
							<div th:case="Accept">
								<button type="button" class="btn btn-success btn-lg me-3" data-bs-toggle="modal" data-bs-target="#exampleModal" th:text="#{acceptNA}"></button>
								<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
									<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title" id="exampleModalLabel" th:text="#{acceptNA}"></h5>
												<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
											<div class="modal-body">
												<form class="mb-3" th:object="${action}" >
													<textarea class="form-control" th:field="*{message}" th:placeholder="#{message}"></textarea>
												</form>
											</div>
											<div class="modal-footer">
												<a type="submit" th:href="@{'/transaction/' + ${transactionID} + '/accept'}" method="post" class="w-100 btn btn-lg btn-primary">Send message</a>
											</div>
										</div>
									</div>
								</div>
							</div>
							<!-- Modal for "Abort" button -->
							<a th:case="Abort" class="btn btn-danger btn-lg me-3" th:text="#{abortNA}" th:href="@{'/transaction/' + ${transactionID} + '/abort'}" method="post"></a>
							<!-- Modal for "Delivery" button -->
							<a th:case="Delivery" class="btn btn-primary btn-lg me-3" th:text="#{deliveryNA}" th:href="@{'/transaction/' + ${transactionID} + '/delivery'}" method="post"></a>
							<!-- Modal for "Invoicing" button -->
							<a th:case="Invoicing" class="btn btn-primary btn-lg me-3" th:text="#{invoicingNA}" th:href="@{'/transaction/' + ${transactionID} + '/invoicing'}" method="post"></a>
							<!-- Modal for "Paid" button -->
							<a th:case="Paid" class="btn btn-primary btn-lg me-3" th:text="#{paidNA}" th:href="@{'/transaction/' + ${transactionID} + '/paid'}" method="post"></a>
						</div>
					</div>
					<a class="btn btn-primary btn-lg me-3" th:href="@{'/transaction/' + ${transactionID} + '/addAction'}" th:text="#{specialActions}"></a>
				</div>
			</div>
		</div>
		<a name="n"></a>
	</th:block>
</body>
</html>
